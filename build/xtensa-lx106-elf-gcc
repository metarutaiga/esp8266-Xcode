#!/bin/bash

ARGS=""
ARGS_GCC=""
USE_GCC=1
while [[ $# > 0 ]] ; do
    case $1 in
        *.S)
        USE_GCC=1;
        ARGS=$ARGS" "$1
        ;;
        */bootloader/*)
        USE_GCC=1;
        ARGS=$ARGS" "$1
        ;;
        *esp_heap_caps.c)
        USE_GCC=1;
        ARGS=$ARGS" "$1
        ;;
        -fstrict-volatile-bitfields)
        ARGS_GCC=$ARGS_GCC" -fstrict-volatile-bitfields"
        ;;
        -g)
        ARGS_GCC=$ARGS_GCC" -g"
        ;;
        -mlongcalls)
        ARGS_GCC=$ARGS_GCC" -mlongcalls"
        ;;
        -Wno-old-style-declaration)
        ARGS_GCC=$ARGS_GCC" -Wno-old-style-declaration"
        ;;
        *md5-internal.c|*sha1-internal.c)
        ARGS=$ARGS" "$1" -mtext-section-literals"
        ;;
        *.c)
        ARGS=$ARGS" "$1
        ARGS_GCC=$ARGS_GCC" -D__FILE__=\""$(basename -- $1)"\" -Wno-builtin-macro-redefined"
        ;;
        *)
        ARGS=$ARGS" "$1
        ;;
    esac
    shift
done

if [ $USE_GCC -eq 1 ]; then
# echo xtensa-lx106-elf-gcc $ARGS_GCC $ARGS
  $BUILD_PATH/xtensa-lx106-elf/bin/xtensa-lx106-elf-gcc $ARGS_GCC $ARGS
  exit $?
else
  ARGS=$ARGS" -D__FILE__=__FILE_NAME__ -Wno-builtin-macro-redefined"
  ARGS=$ARGS" -target xtensa-lx106-elf -mcpu=esp8266 -fuse-ld=$BUILD_PATH/xtensa-lx106-elf-lld"
  ARGS=$ARGS" -Wno-sometimes-uninitialized"
  ARGS=$ARGS" -Wno-unused-command-line-argument" 
  ARGS=$ARGS" -Wno-parentheses-equality"
  ARGS=$ARGS" -Wno-tautological-pointer-compare"
  ARGS=$ARGS" -Wno-unknown-pragmas"
  ARGS=$ARGS" -Wno-uninitialized"
  ARGS=$ARGS" -Wno-array-parameter"
  ARGS=$ARGS" -Wno-format-security"
  ARGS=$ARGS" -Oz"

# echo clang $ARGS
  clang $ARGS
  exit $?
fi